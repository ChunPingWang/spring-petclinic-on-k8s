# Docker Compose for local development (standalone mode - no Spring Cloud infrastructure)
# For Kubernetes deployment, use k8s/ manifests instead
#
# Removed services (replaced by K8s native solutions):
#   - config-server (use K8s ConfigMap/Secret)
#   - discovery-server (use K8s Service Discovery)
#   - admin-server (use Prometheus + Grafana)

services:
  # Database
  mysql:
    image: mysql:8.4
    container_name: mysql
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=petclinic
      - MYSQL_USER=petclinic
      - MYSQL_PASSWORD=petclinic
    deploy:
      resources:
        limits:
          memory: 512M
    ports:
      - 3306:3306
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 10

  # Business Services
  customers-service:
    image: petclinic/customers-service:latest
    container_name: customers-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/petclinic
      - SPRING_DATASOURCE_USERNAME=petclinic
      - SPRING_DATASOURCE_PASSWORD=petclinic
      - SPRING_PROFILES_ACTIVE=mysql
      - MANAGEMENT_ZIPKIN_TRACING_ENDPOINT=http://tracing-server:9411/api/v2/spans
    deploy:
      resources:
        limits:
          memory: 1G
    depends_on:
      mysql:
        condition: service_healthy
    ports:
      - 8081:8081

  visits-service:
    image: petclinic/visits-service:latest
    container_name: visits-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/petclinic
      - SPRING_DATASOURCE_USERNAME=petclinic
      - SPRING_DATASOURCE_PASSWORD=petclinic
      - SPRING_PROFILES_ACTIVE=mysql
      - MANAGEMENT_ZIPKIN_TRACING_ENDPOINT=http://tracing-server:9411/api/v2/spans
    deploy:
      resources:
        limits:
          memory: 1G
    depends_on:
      mysql:
        condition: service_healthy
    ports:
      - 8082:8082

  vets-service:
    image: petclinic/vets-service:latest
    container_name: vets-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/petclinic
      - SPRING_DATASOURCE_USERNAME=petclinic
      - SPRING_DATASOURCE_PASSWORD=petclinic
      - SPRING_PROFILES_ACTIVE=mysql
      - MANAGEMENT_ZIPKIN_TRACING_ENDPOINT=http://tracing-server:9411/api/v2/spans
    deploy:
      resources:
        limits:
          memory: 1G
    depends_on:
      mysql:
        condition: service_healthy
    ports:
      - 8083:8083

  genai-service:
    image: petclinic/genai-service:latest
    container_name: genai-service
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - AZURE_OPENAI_KEY=${AZURE_OPENAI_KEY}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - MANAGEMENT_ZIPKIN_TRACING_ENDPOINT=http://tracing-server:9411/api/v2/spans
    deploy:
      resources:
        limits:
          memory: 1G
    ports:
      - 8084:8084

  api-gateway:
    image: petclinic/api-gateway:latest
    container_name: api-gateway
    environment:
      - CUSTOMERS_SERVICE_URL=http://customers-service:8081
      - VISITS_SERVICE_URL=http://visits-service:8082
      - MANAGEMENT_ZIPKIN_TRACING_ENDPOINT=http://tracing-server:9411/api/v2/spans
    deploy:
      resources:
        limits:
          memory: 1G
    depends_on:
      - customers-service
      - visits-service
      - vets-service
    ports:
      - 8080:8080

  # Infrastructure Services
  tracing-server:
    image: openzipkin/zipkin
    container_name: tracing-server
    deploy:
      resources:
        limits:
          memory: 512M
    ports:
      - 9411:9411

  prometheus-server:
    build: ./docker/prometheus
    container_name: prometheus-server
    deploy:
      resources:
        limits:
          memory: 256M
    ports:
      - 9091:9090

  grafana-server:
    build: ./docker/grafana
    container_name: grafana-server
    deploy:
      resources:
        limits:
          memory: 256M
    ports:
      - 3030:3000
